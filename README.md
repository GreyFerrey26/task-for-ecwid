# Count unique ipv4 addresses in big files

The following project is my solution for an optimized way to solve the interview task: given the big text file, containing only ipv4 addressed (one per line), the application should count the number of unique IP addresses in that file.

### Notes

For the task, I created a solution that can generate a file with random IPs, all IPs (which would be around 64Gb on my PC), read from the file and do a simple run with a specified or unspecified amount of IP addresses. The temporary files would be created, read, counted for unique IP addresses and deleted after.

By running this app by default, it would run the latter on 4 files, with 1000 lines, 1000000 lines, 10000000 lines and 100000000 lines.

Most of my attention was put into optimizing the algorithm, so generation could be buggy. I also ignored most IOException for the task, as it isn't the focus.

Check out additional info at the bottom!

## Solution

From the start, it's obvious, that calculating should not contain any real String operation (like ***split()***) and should go line per line and symbol per symbol.

Next, most of the default collection implementations would lose effectiveness on such a big amount of data (the task specified that the files could be 50+ or 100+ GBs).

Each part of the IP, basically, a 8 bits of information (0-255). That means that the entire ipv4 address could be transformed into 32 bits of information, which would work perfectly with an unsigned integer.

The best approach seems to be working with an array sized to *2^32* and parsing each line on the fly, adding a true bit to said array.

To achieve peak efficiency, instead of a usual fixed array, we could use a BitSet, as it would grow as needed.

## Problems

First of all, Java doesn't have an unsigned integer out of the box. That means that any transformed IP address could be positive or negative.

Second, BitSet has its size fixed as an integer, so it's capped at an *Integer.MAX_VALUE = 2^31-1*.

To work around this, my solution is to use two BitSets, one for positive integers and one for the negatives. So any parsed int could be collected in one of them and then ***cardinality()*** method would count the number of bits set to true (aka unique IP addresses in that BitSet).

The other problem arose, as two BitSets could only cover *2^32 - 2 bits* (see size of a BitSet above). To work around it, we could create a third BitSet, or, as a more elegant solution, I preferred to just keep track of the biggest int possible (*2^31-1* or *127.255.255.255* ip) and lowest int possible (*-2^31* or *128.0.0.0* ip) as two booleans. After the text file is parsed, we need to sum two results of ***cardinality()*** on both BitSets and add plus one for each valued true tracking boolean.

My tests cover simple situations of file with IPs generation and reading them, as well as working around two "special" IP addresses from above. The third test is optional and enabled by setting the environment variable 'IpAddrAllIpsHeavyLoadTest' to 'true' (case insensitive). It generates single file with all possible ipv4 IPs and counts uniques in it. On my PC it takes around ~10 minutes and 64 GB of IP addresses.  It's not needed but shows that my solution could work with any ipv4 address and doesn't overflow into negatives in BitSets/cardinality results.

### How to use

By running this app by default, it would generate 4 files, with 1000 lines, 1000000 lines, 10000000 lines and 100000000 lines of IPs and proceed to read them and count uniques, printing its' results into the console.

I also included a couple of simple modes that could help in working and testing this app. I didn't go overboard with testing each of non-primary functionality, but it worked for me as I tested and experimented with my solution.

Only one mode argument be active at the time!

| Name         | Mode argument | Additional args                    | How it works                                                                                  | Notes                                                      | Example                                                                                     | Output                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|--------------|---------------|------------------------------------|-----------------------------------------------------------------------------------------------|------------------------------------------------------------|---------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| GENERATE     | -g            | filePath(String) amountOfIps(Long) | Generates file at *filePath*, with *amountOfIps* random ipv4 addresses                        | Will override said file if exists                          | java -jar ip-addr-counter-1.0-SNAPSHOT-jar-with-dependencies.jar -g D:/Test/123.txt 1000000 | <details><summary>Output</summary>03 Jun 23:20:37 INFO [utils.FilesUtils] - Creating file D:\Test\123.txt<br/>03 Jun 23:20:37 INFO [worker.IpAddrCounterWorker] - File 'D:\Test\123.txt' with 1000000 ips generated in 158 ms</details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| GENERATE_ALL | -ga           | filePath(String)                   | Generates file at *filePath*, with 4294967296 lines, containing every ipv4                    | VERY HEAVY AND SLOW.<br/>Will override said file if exists | java -jar ip-addr-counter-1.0-SNAPSHOT-jar-with-dependencies.jar -ga D:/Test/allIps.txt     | <details><summary>Output</summary>04 Jun 00:27:48 INFO [utils.FilesUtils] - Creating file D:\Test\allIps.txt<br/>04 Jun 00:32:46 INFO [worker.IpAddrCounterWorker] - File 'D:\Test\allIps.txt' with all possible ips generated in 298424 ms</details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| RUN          | -r            | amountOfIps(Long..)                | Creates temporary files with *amountOfIps* amount of lines, count unique IPs and delete files | Default functionality                                      | java -jar ip-addr-counter-1.0-SNAPSHOT-jar-with-dependencies.jar -r 100000 1000000 10000000 | <details><summary>Output</summary>03 Jun 23:29:13 INFO [utils.FilesUtils] - Creating file C:\Users\GREYFE~1\AppData\Local\Temp\ips_100000_5565247051248814468.txt<br/>03 Jun 23:29:13 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_100000_5565247051248814468.txt' with 100000 ips generated in 91 ms<br/>03 Jun 23:29:13 INFO [worker.IpAddrCounterWorker] - Started reading file 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_100000_5565247051248814468.txt'<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - Time to count uniques in 100000 ips: 250 ms<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - 99998/100000 uniques found<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_100000_5565247051248814468.txt' deleted<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] -<br/>03 Jun 23:29:14 INFO [utils.FilesUtils] - Creating file C:\Users\GREYFE~1\AppData\Local\Temp\ips_1000000_1688832725624582866.txt<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_1000000_1688832725624582866.txt' with 1000000 ips generated in 125 ms<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - Started reading file 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_1000000_1688832725624582866.txt'<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - Time to count uniques in 1000000 ips: 325 ms<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - 999895/1000000 uniques found<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_1000000_1688832725624582866.txt' deleted<br/>03 Jun 23:29:14 INFO [worker.IpAddrCounterWorker] -<br/>03 Jun 23:29:14 INFO [utils.FilesUtils] - Creating file C:\Users\GREYFE~1\AppData\Local\Temp\ips_10000000_14783410061610485393.txt<br/>03 Jun 23:29:15 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_10000000_14783410061610485393.txt' with 10000000 ips generated in 985 ms<br/>03 Jun 23:29:15 INFO [worker.IpAddrCounterWorker] - Started reading file 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_10000000_14783410061610485393.txt'<br/>03 Jun 23:29:17 INFO [worker.IpAddrCounterWorker] - Time to count uniques in 10000000 ips: 1671 ms<br/>03 Jun 23:29:17 INFO [worker.IpAddrCounterWorker] - 9988301/10000000 uniques found<br/>03 Jun 23:29:17 INFO [worker.IpAddrCounterWorker] - File 'C:\Users\GREYFE~1\AppData\Local\Temp\ips_10000000_14783410061610485393.txt' deleted</details> |
| FILE         | -f            | filePath(String)                   | Reads existing file at *filePath* and count unique IPs                                        |                                                            | java -jar ip-addr-counter-1.0-SNAPSHOT-jar-with-dependencies.jar -f D:/Test/123.txt         | <details><summary>Output</summary>03 Jun 23:31:49 INFO [worker.IpAddrCounterWorker] - Started reading file 'D:\Test\123.txt'<br/>03 Jun 23:31:49 INFO [worker.IpAddrCounterWorker] - Time to count uniques in 100000 ips: 247 ms<br/>03 Jun 23:31:49 INFO [worker.IpAddrCounterWorker] - 100000/100000 uniques found</details>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
